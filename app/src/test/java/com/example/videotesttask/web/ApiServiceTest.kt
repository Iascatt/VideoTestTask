package com.example.videotesttask.web

import com.example.videotesttask.data.remote.VideoApi
import junit.framework.TestCase.assertEquals
import kotlinx.coroutines.runBlocking
import okhttp3.OkHttpClient
import okhttp3.mockwebserver.MockResponse
import okhttp3.mockwebserver.MockWebServer
import org.junit.After
import org.junit.Before
import org.junit.Test
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory

class ApiServiceTest {

    private lateinit var mockWebServer: MockWebServer
    private lateinit var apiService: VideoApi

    @Before
    fun setup() {
        mockWebServer = MockWebServer()
        mockWebServer.start()

        val retrofit = Retrofit.Builder()
            .baseUrl(mockWebServer.url("/"))
            .addConverterFactory(GsonConverterFactory.create())
            .client(OkHttpClient())
            .build()

        apiService = retrofit.create(VideoApi::class.java)
    }

    @After
    fun tearDown() {
        mockWebServer.shutdown()
    }

    @Test
    fun testItems() = runBlocking {
        val mockResponse = MockResponse()
            .setResponseCode(200)
            .setBody("""
{"collection":{"version":"1.1","href":"http://images-api.nasa.gov/search?media_type=video&page=1&page_size=5","items":[{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/collection.json","data":[{"center":"GRC","date_created":"2023-12-29T00:00:00Z","description":"Ice formed on the blades of a rotating rotor.  In time the ice accumulation builds up and is then shed or spun off the blades.  High-speed video captures this event in slow motion for analysis.","keywords":["High-speed","spinning rotor blades","Icing Research Tunnel","Ice shedding","wind tunnel test"],"location":"Glenn Research Center","media_type":"video","nasa_id":"Rotor Test High Speed Video of Ice Shed","photographer":"Quentin Schwinn","secondary_creator":"Jordan Salkin","title":"Rotor Test High Speed Video of Ice Shed"}],"links":[{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large.jpg","rel":"alternate","render":"image","width":800,"size":23000,"height":450},{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium.jpg","rel":"alternate","render":"image","width":400,"size":8100,"height":225},{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small.jpg","rel":"alternate","render":"image","width":200,"size":3200,"height":112},{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb.jpg","rel":"preview","render":"image","width":300,"size":5200,"height":168},{"href":"https://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed.srt","rel":"captions"}]},{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/collection.json","data":[{"album":["Features-Videos"],"center":"KSC","date_created":"2006-10-25T00:00:00Z","description":"George Diller interviews Kennedy Space Center Director, James Kennedy in the STEREO Launch Control Center. STEREO (Solar Terrestrial Relations Observatory) is a two-year mission using two nearly identical observatories, one ahead of Earth in its orbit and the other trailing behind. The duo will provide 3-D measurements of the sun and its flow of energy, enabling scientists to study the nature of coronal mass ejections and why they happen.","keywords":["STEREO","Solar_TErrestrial_RElations_Observatory","boeing_delta_II"],"media_type":"video","nasa_id":"ksc_102506_stereo_kennedy","photographer":"NASA_or_National_Aeronautics_and_Space_Administration","title":"KSC-06-S-00217"}],"links":[{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/ksc_102506_stereo_kennedy~large.jpg","rel":"alternate","render":"image","width":800,"size":21000,"height":450},{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/ksc_102506_stereo_kennedy~medium.jpg","rel":"alternate","render":"image","width":400,"size":11000,"height":225},{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/ksc_102506_stereo_kennedy~small.jpg","rel":"alternate","render":"image","width":200,"size":3900,"height":112},{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/ksc_102506_stereo_kennedy~thumb.jpg","rel":"preview","render":"image","width":300,"size":7100,"height":168},{"href":"https://images-assets.nasa.gov/video/ksc_102506_stereo_kennedy/ksc_102506_stereo_kennedy.vtt","rel":"captions"}]},{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/collection.json","data":[{"album":["Whats_Up"],"center":"JPL","date_created":"2020-09-01T00:00:00Z","description":"What are some skywatching highlights in September 2020? Spot the Moon together with Mars and Venus, along with the flickering star Fomalhaut, which had itself a planet...until it didn't! ","keywords":["NASA","JPL","Jet Propulsion Laboratory","What's Up","Whats Up","WhatsUp","Fomalhaut","exoplanet","Hubble","Venus","Mars","Jupiter","Saturn","Moon","Moon phases","observing","stargazing","star gazing","astrophotography","skywatching","skywatching for beginners","sky chart","star chart","star party","space","astronomy","planets","stars","science","family","fun","free","night","STEM"],"media_type":"video","nasa_id":"JPL-20200901-WHATSUf-0001-Whats_Up_September_2020","photographer":"NASA's Jet Propulsion Laboratory","title":"What's Up: September 2020 Skywatching Tips from NASA"}],"links":[{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020~large.jpg","rel":"alternate","render":"image","width":800,"size":16000,"height":450},{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020~medium.jpg","rel":"alternate","render":"image","width":400,"size":5300,"height":225},{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020~small.jpg","rel":"alternate","render":"image","width":200,"size":2300,"height":112},{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020~thumb.jpg","rel":"preview","render":"image","width":300,"size":4200,"height":168},{"href":"https://images-assets.nasa.gov/video/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020/JPL-20200901-WHATSUf-0001-Whats_Up_September_2020.vtt","rel":"captions"}]},{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/collection.json","data":[{"album":["Features-Videos"],"center":"KSC","date_created":"2006-04-21T00:00:00Z","description":"NASA Commentator Bruce Buckingham interviews CALIPSO Project Manager during coverage of the CALIPSO_CloudSat launch aboard a Delta II rocket from Vandenberg Air Force Base in California. CALIPSO stands for Cloud-Aerosol Lidar and Infrared Pathfinder Satellite Observation. It will fly in combination with the CloudSat satellite to provide never-before-seen 3-D perspectives of how clouds and aerosols form, evolve, and affect weather and climate. CALIPSO and CloudSat will join three other satellites in orbit to enhance understanding of climate systems.","keywords":["calipso","cloudsat","aerosol","earth","clouds","weather","climate","delta","vandenberg"],"media_type":"video","nasa_id":"van_042106_cc_brown","photographer":"NASA or National Aeronautics and Space Administration","title":"KSC-06-S-00108"}],"links":[{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/van_042106_cc_brown~large.jpg","rel":"alternate","render":"image","width":800,"size":18000,"height":450},{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/van_042106_cc_brown~medium.jpg","rel":"alternate","render":"image","width":400,"size":8600,"height":225},{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/van_042106_cc_brown~small.jpg","rel":"alternate","render":"image","width":200,"size":3600,"height":112},{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/van_042106_cc_brown~thumb.jpg","rel":"preview","render":"image","width":300,"size":6200,"height":168},{"href":"https://images-assets.nasa.gov/video/van_042106_cc_brown/van_042106_cc_brown.vtt","rel":"captions"}]},{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/collection.json","data":[{"album":["Artemis_II"],"center":"KSC","date_created":"2023-12-21T00:00:00Z","description":"Processing of the Artemis II booster inside the RPSF at Kennedy Space Center","keywords":["Artemis","Artemis II","Artemis II resource reel","SRB","RPSF","booster","booster processing","grain inspection"],"location":"KSC","media_type":"video","nasa_id":"KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176","photographer":"NASA/Glenn Benson","title":"Artemis II Booster Grain Inspection and Move to Work Stand"}],"links":[{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176~large.jpg","rel":"alternate","render":"image","width":800,"size":17000,"height":450},{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176~medium.jpg","rel":"alternate","render":"image","width":400,"size":8800,"height":225},{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176~small.jpg","rel":"alternate","render":"image","width":200,"size":3800,"height":112},{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176~thumb.jpg","rel":"preview","render":"image","width":300,"size":6100,"height":168},{"href":"https://images-assets.nasa.gov/video/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176/KSC-20231221-MH-GEB01-0002-Artemis_II_SRB_Grain_ Inspection_Move_to_Work_Stand-M3176.vtt","rel":"captions"}]}],"metadata":{"total_hits":7684},"links":[{"rel":"next","prompt":"Next","href":"http://images-api.nasa.gov/search?media_type=video&page=2&page_size=5"}]}}
            """.trimIndent())
        mockWebServer.enqueue(mockResponse)

        val response = apiService.getCollection(1, 5)

        assertEquals(true, response.isSuccessful)
        assertEquals(200, response.code())

        val collection = response.body()
        assertEquals("http://images-api.nasa.gov/search?media_type=video&page=1&page_size=5",
                collection?.collection?.href)
    }

    @Test
    fun testVideos() = runBlocking {
        val mockResponse = MockResponse()
            .setResponseCode(200)
            .setBody("""
["http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~orig.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~mobile.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~preview.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed.srt", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~orig.mp4", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/metadata.json", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small_1.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small_2.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small_3.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small_4.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~small_5.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb_1.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb_2.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb_3.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb_4.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~thumb_5.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium_1.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium_2.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium_3.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium_4.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~medium_5.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large_1.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large_2.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large_3.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large_4.jpg", "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~large_5.jpg"]
        """.trimIndent())
        mockWebServer.enqueue(mockResponse)

        val response = apiService.getVideoFiles("")

        assertEquals(true, response.isSuccessful)
        assertEquals(200, response.code())

        if (!response.body().isNullOrEmpty())
        assertEquals(
            "http://images-assets.nasa.gov/video/Rotor Test High Speed Video of Ice Shed/Rotor Test High Speed Video of Ice Shed~orig.mp4",
            response.body()!![0])

    }
}